<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>practice2</title>
    <link
      rel="stylesheet"
      href="http://192.168.137.113/arcgis_js_api/library/4.18/esri/themes/light/main.css"
    />
    <script src="http://192.168.137.113/arcgis_js_api/library/4.18/init.js"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #infoDiv {
        background-color: white;
        color: black;
        padding: 15px;
        width: 330px;
      }

      #dropDowns {
        padding-bottom: 15px;
      }

      #formDiv {
        background: #fff;
      }
      .scroller {
        overflow-x: hidden;
        overflow-y: auto;
      }
      .esri-item-list__scroller {
        overflow-y: visible;
      }

      .editArea-container {
        background: #fff;
        line-height: 1.5em;
        overflow: auto;
        padding: 12px 15px;
        width: 300px;
      }
    </style>
    <script>
      require([
        "esri/Map",
        "esri/Graphic",
        "esri/views/MapView",
        "esri/layers/MapImagelayer",
        "esri/layers/GraphicsLayer",
        "esri/layers/FeatureLayer",
        "esri/tasks/QueryTask",
        "esri/tasks/support/Query",
        "esri/widgets/FeatureTemplates",
        "esri/widgets/FeatureForm",
      ], function (
        Map,
        Graphic,
        MapView,
        MapImageLayer,
        GraphicsLayer,
        FeatureLayer,
        QueryTask,
        Query,
        FeatureTemplates,
        FeatureForm
      ) {
        var imageLayer = new MapImageLayer({
          url: "http://192.168.137.113/server/rest/services/20210129二维矢量地图/MapServer",
        });
        var featureLayer = new FeatureLayer({
          url: "http://192.168.137.113/server/rest/services/20200917AP点位/MapServer/0",
        });
        var resultsLayer = new GraphicsLayer();

        var map = new Map({
          //底图
          layers: [imageLayer, featureLayer, resultsLayer],
        });
        var view = new MapView({
          //视图
          container: "viewDiv",
          map: map,
          zoom: 4,
          scale: 16000,
          center: [114.40776, 30.51415],
        });
        view.when(function () {
          view.ui.add("infoDiv", "top-left");
          view.ui.add("editArea", "top-right");
          document.getElementById("wellType").onchange = apQuery;

          document.getElementById("doBtn").onclick = pointsQueryTask;
          document.getElementById("testPoint").onclick = function () {
            document.getElementById("pointQuery").value =
              "EC0B323AD70C41D3AF9D5F103E364107";
          };
          document.getElementById("testPoint2").onclick = function () {
            document.getElementById("pointQuery").value =
              "E248B03DF7704FFF81DFB2A85B1EF8DE";
          };
        });
        //2.根据AP图层的LC（楼层）属性，显示不同楼层的AP点位；通过下拉框选择楼层
        function apQuery() {
          let att = document.getElementById("wellType");
          featureLayer.definitionExpression = "lc = '" + att.value + "'";

          featureLayer.queryFeatures().then(function (results) {
            //执行查询展示搜索结果数量
            console.log(results.declaredClass);
            let apCount = results.features.length;
            //展示结果数量
            document.getElementById("apResultConut").innerHTML =
              apCount + "条结果";
          });
        }
        //3.根据PointGUID属性，查询对应的AP，并进行跳转
        var query = new Query({
          returnGeometry: true,
          outFields: ["*"],
        });
        function pointsQueryTask() {
          resultsLayer.removeAll(); //清空上次查询
          let pointAtt = document.getElementById("pointQuery");
          query.where = "pointGUID = '" + pointAtt.value + "'";
          query.outSpatialReference = view.spatialReference; //
          let queryTask = new QueryTask({
            url: "http://192.168.137.113/server/rest/services/20200917AP点位/MapServer/0",
          });
          queryTask.execute(query).then(getPointResults); //执行查询
        }
        function getPointResults(res) {
          let pointResults = res.features.map(function (feature) {
            feature.symbol = {
              //渲染
              type: "simple-marker",
              size: 10,
              color: "red",
            };
            feature.popupTemplate = {
              //设置弹窗
              title: "AP",
              content: [
                {
                  type: "fields",
                  fieldInfos: [
                    {
                      fieldName: "OBJECTID",
                      label: "xxx",
                      type: "oid",
                    },
                    {
                      fieldName: "Shape",
                      label: "Shape",
                      type: "geometry",
                    },
                    {
                      fieldName: "FWBM",
                      label: "FWBM",
                      type: "string",
                    },
                    {
                      fieldName: "LC",
                      label: "LC",
                      type: "string",
                    },
                    {
                      fieldName: "PointGUID",
                      label: "PointGUID",
                      type: "string",
                    },
                    {
                      fieldName: "FJGUID",
                      label: "FJGUID",
                      type: "string",
                    },
                  ],
                },
              ],
            };
            return feature;
          });
          resultsLayer.addMany(pointResults);
          //console.log(pointResults[0].declaredClass);
          console.log(view);
          console.log(res.features);
          view.goTo(res.features).catch(function (error) {
            if (error.name != "AbortError") {
              alert.error(error);
            }
          });
        }
        //4.要素图层的编辑（添加、修改、删除）
        var blankFeatureLayer = new FeatureLayer({
          url: "http://192.168.137.113/server/rest/services/Hosted/20201123空白AP图层姚刚用/FeatureServer/1",
          id: "incidentsLayer",
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-marker",
              color: "#ffff00",
              size: 15,
            },
          },
          outFields: ["*"],
          formTemplate: {
            title: "修改属性",
            description: "输入相应值以修改属性",
            elements: [
              {
                // Autocasts to new FieldElement
                type: "field",
                fieldName: "fwbm",
                label: "-fwbm-",
              },
              {
                type: "field",
                fieldName: "lc",
                label: "-lc-",
              },
              {
                type: "field",
                fieldName: "flag",
                label: "-flag-",
              },
            ],
          },
        });
        map.add(blankFeatureLayer);
        let highlight, editFeature;
        const form = new FeatureForm({
          container: "formDiv",
          layer: blankFeatureLayer,
        });
        //监听表单提交事件
        form.on("submit", function () {
          if (editFeature) {
            const updated = form.getValues();
            Object.keys(updated).forEach(function (name) {
              editFeature.attributes[name] = updated[name];
            });
            const edits = {
              updateFeatures: [editFeature],
            };
            applyEditsAttributes(edits);
            document.getElementById("viewDiv").style.cursor = "auto";
          }
        });
        selectExistingFeature();
        const templates = new FeatureTemplates({
          container: "addTemplatesDiv",
          layers: [blankFeatureLayer],
        });
        templates.on("select", function (evtTemplate) {
          attributes = evtTemplate.template.prototype.attributes;
          unselectFeature();
          document.getElementById("viewDiv").style.cursor = "crosshair";
          const handler = view.on("click", function (event) {
            // remove click event handler once user clicks on the view
            // to create a new feature
            handler.remove();
            event.stopPropagation();
            form.feature = null;

            if (event.mapPoint) {
              point = event.mapPoint.clone();
              point.z = undefined;
              point.hasZ = false;

              // Create a new feature using one of the selected
              // template items.
              editFeature = new Graphic({
                geometry: point,
                attributes: {
                  IncidentType: attributes.IncidentType,
                },
              });

              // Setup the applyEdits parameter with adds.
              const edits = {
                addFeatures: [editFeature],
              };
              applyEditsAttributes(edits);
              document.getElementById("viewDiv").style.cursor = "auto";
            } else {
              console.error("event.mapPoint is not defined");
            }
          });
        });
        // 执行属性修改
        function applyEditsAttributes(params) {
          blankFeatureLayer
            .applyEdits(params)
            .then(function (editsResult) {
              if (
                editsResult.addFeatureResults.length > 0 ||
                editsResult.updateFeatureResults.length > 0
              ) {
                unselectFeature();
                let objectId;
                if (editsResult.addFeatureResults.length > 0) {
                  objectId = editsResult.addFeatureResults[0].objectId;
                } else {
                  featureForm.feature = null;
                  objectId = editsResult.updateFeatureResults[0].objectId;
                }
                selectFeature(objectId);
                if (addFeatureDiv.style.display === "block") {
                  toggleEditingDivs("none", "block");
                }
              } else if (editsResult.deleteFeatureResults.length > 0) {
                toggleEditingDivs("block", "none");
              }
            })
            .catch(function (error) {
              console.log("===============================================");
              console.error(
                "[ applyEdits ] FAILURE: ",
                error.code,
                error.name,
                error.message
              );
              console.log("error = ", error);
            });
        }

        function selectExistingFeature() {
          view.on("click", function (event) {
            // clear previous feature selection
            unselectFeature();
            if (
              document.getElementById("viewDiv").style.cursor != "crosshair"
            ) {
              view.hitTest(event).then(function (response) {
                // If a user clicks on an incident feature, select the feature.
                if (response.results.length === 0) {
                  toggleEditingDivs("block", "none");
                } else if (
                  response.results[0].graphic &&
                  response.results[0].graphic.layer.id == "incidentsLayer"
                ) {
                  if (addFeatureDiv.style.display === "block") {
                    toggleEditingDivs("none", "block");
                  }
                  selectFeature(
                    response.results[0].graphic.attributes[
                      blankFeatureLayer.objectIdField
                    ]
                  );
                }
              });
            }
          });
        }
        // 未选择feature时去除高亮
        function unselectFeature() {
          if (highlight) {
            highlight.remove();
          }
        }
        // 表单中展示点击的feature的field值
        function selectFeature(objectId) {
          blankFeatureLayer
            .queryFeatures({
              objectIds: [objectId],
              outFields: ["*"],
            })
            .then(function (res) {
              if (res.features.length > 0) {
                editFeature = res.features[0];
                // 在表单中展示fields
                form.feature = editFeature;
                // 高亮显示feature
                view
                  .whenLayerView(editFeature.layer)
                  .then(function (layerView) {
                    highlight = layerView.highlight(editFeature);
                  });
              }
            });
        }

        const addFeatureDiv = document.getElementById("addFeatureDiv");
        const attributeEditing = document.getElementById("featureUpdateDiv");
        // 控制Div的消失与出现
        function toggleEditingDivs(addDiv, attributesDiv) {
          addFeatureDiv.style.display = addDiv;

          attributeEditing.style.display = attributesDiv;
        }
        //document.getElementById("btnAdd").onclick = evt;
        // 修改feature
        document.getElementById("btnUpdate").onclick = function () {
          form.submit();
        };
        // 删除feature
        document.getElementById("btnDelete").onclick = function () {
          // setup the applyEdits parameter with deletes.
          const edits = {
            deleteFeatures: [editFeature],
          };
          applyEditsAttributes(edits);
          document.getElementById("viewDiv").style.cursor = "auto";
        };
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="infoDiv" class="esri-widget">
      <div id="dropDowns">
        选择楼层
        <select id="wellType" class="esri-widget">
          <option value="">请选择</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>
        <span id="apResultConut"></span>
      </div>
      <div>
        <div id="pointQueryDiv">
          <input id="pointQuery" type="text" placeholder="请输入pointGUID" />
          <button id="doBtn" class="esri-widget">查询</button>
        </div>
        <div>
          <button id="testPoint">测试点1</button>
          <button id="testPoint2">测试点2</button>
          <span id="copyResult"></span>
        </div>
      </div>
    </div>

    <div id="editArea" class="editArea-container esri-widget--panel">
      <div id="addFeatureDiv" style="display: block">
        <ul style="font-size: 15px; padding-left: 1.5em">
          <li>选择过滤器类型以添加新要素</li>
          <li>选择已有要素进行修改</li>
          <li>选择已有要素进行删除</li>
        </ul>
        <!-- <button id="btnAdd" class="esri-button">添加要素</button> -->
        <div id="addTemplatesDiv" style="background: #fff"></div>
      </div>

      <div id="featureUpdateDiv" style="display: none" class="esri-widget">
        <div id="formDiv" class="scroller esri-component"></div>
        <input
          type="button"
          class="esri-button"
          value="更新要素"
          id="btnUpdate"
        />
        <br />
        <input
          type="button"
          class="esri-button"
          value="删除要素"
          id="btnDelete"
        />
      </div>
    </div>
  </body>
</html>
